name: CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yaml
        run: |
          docker compose config > /dev/null
          echo "✅ docker-compose.yaml is valid"

      - name: Check .env.example exists
        run: |
          if [ ! -f .env.example ]; then
            echo "❌ .env.example not found!"
            exit 1
          fi
          echo "✅ .env.example exists"

  yaml-lint:
    name: YAML Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: docker-compose.yaml .github/workflows/
          config_data: |
            extends: default
            rules:
              line-length:
                max: 200
                level: warning
              comments:
                min-spaces-from-content: 1

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-test:
    name: Build Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create test .env
        run: |
          cp .env.example .env
          sed -i 's/HIER_SICHERES_PASSWORT_EINTRAGEN/test_password_123/g' .env
          sed -i 's/HIER_SICHERES_ROOT_PASSWORT_EINTRAGEN/test_root_password_123/g' .env
          sed -i 's|/pfad/zu/ihrem/backup|/tmp/backup|g' .env
          sed -i 's|Host(`ihre-domain.de`)|Host(`localhost`)|g' .env

      - name: Create volumes
        run: |
          mkdir -p volumes/html volumes/sql

      - name: Build containers
        run: |
          docker compose build --pull

      - name: Start containers
        run: |
          docker compose up -d sql redis
          sleep 10

      - name: Check container health
        run: |
          docker compose ps
          docker compose logs sql
          docker compose logs redis

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

  config-check:
    name: Configuration Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required config files
        run: |
          files=(
            "configs/php/matomo.ini"
            "configs/sql/custom.cnf"
            "configs/apache/matomo-security.conf"
            ".env.example"
            ".gitignore"
            "README.md"
            "README.en.md"
            "README.fr.md"
          )

          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
            echo "✅ Found: $file"
          done

      - name: Check for sensitive data in repository
        run: |
          if grep -r "ironman.projektleder.de" --exclude-dir=.git .; then
            echo "❌ Found hardcoded production domain!"
            exit 1
          fi
          echo "✅ No hardcoded production domains found"
